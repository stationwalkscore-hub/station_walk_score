<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Station Walk Score</title>

  <style>
    :root{
      --border:#e5e7eb;
      --border2:#d1d5db;
      --bg:#ffffff;
      --bg-soft:#f9fafb;
      --text-muted:#6b7280;
      --text-danger:#b91c1c;
      --radius:16px;

      /* ★結果欄のフォントサイズ調整 */
      --result-score: clamp(28px, 6vw, 44px);
      --result-name:  clamp(24px, 5.2vw, 40px); /* ←スコアより“一回り小さく” */
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      margin: 24px;
      background: var(--bg);
    }

    .card{
      max-width: 720px;
      margin: 0 auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    h1{ font-size: 20px; margin: 0 0 12px; }

    .row{ display:flex; gap:8px; align-items:center; }
    input{
      flex:1;
      padding: 10px 12px;
      border: 1px solid var(--border2);
      border-radius: 10px;
      font-size: 16px;
    }
    button{
      padding: 10px 12px;
      border: 1px solid var(--border2);
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
    }
    button:hover{ background: var(--bg-soft); }

    .hint{ color: var(--text-muted); font-size: 13px; margin-top: 8px; }
    .error{ color: var(--text-danger); font-size: 12px; margin-top: 10px; display:none; }

    .suggest{ margin-top: 10px; }
    .suggest-item{
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
      cursor: pointer;
      user-select: none;
    }
    .suggest-item:hover{ background: var(--bg-soft); }

    /* =========================
       Result (駅名を一回り小さく / 右端固定 / 1行)
       ========================= */
    .result{
      margin-top: 14px;
      padding: 16px;
      border-radius: 12px;
      background: var(--bg-soft);
      border: 1px solid var(--border);

      display: grid;
      grid-template-columns: 1fr auto;
      align-items: baseline;     /* 上下揃え */
      column-gap: 12px;
    }

    .result .name{
      grid-column: 1;
      font-size: var(--result-name); /* ★小さくした */
      font-weight: 900;
      line-height: 1;
      margin: 0;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .result .score{
      grid-column: 2;
      justify-self: end;         /* 右端固定 */
      font-size: var(--result-score);
      font-weight: 900;
      line-height: 1;
      margin: 0;
      white-space: nowrap;
    }

    /* =========================
       History
       ========================= */
    .history{
      margin-top: 14px;
      padding: 16px;
      border-radius: 14px;
      background: #fff;
      border: 1px solid var(--border);
      display:none;
    }
    .history-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .history-title{ font-size: 16px; font-weight: 800; }
    .history-list{ margin-top: 12px; display:grid; gap: 12px; }

    .history-item{
      position: relative;
      padding: 16px 60px 16px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
      background: #fff;
    }
    .history-item:hover{ background: var(--bg-soft); }

    .history-top{ display:flex; justify-content:space-between; align-items:flex-start; gap: 12px; }
    .history-name{
      font-size: 18px;
      font-weight: 900;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-right{
      text-align:right;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 6px;
      white-space: nowrap;
    }
    .history-score{
      font-size: 26px;
      font-weight: 950;
      line-height: 1;
    }
    .history-meta{
      color: var(--text-muted);
      font-size: 13px;
    }

    .history-del{
      position:absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }
    .history-del:hover{ background: var(--bg-soft); }

    /* =========================
       Legal
       ========================= */
    .legal{ margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); }
    .legal-note{ color: var(--text-muted); font-size: 12px; line-height: 1.6; margin: 0 0 10px; }
    .legal h2{ font-size: 14px; margin: 12px 0 6px; }
    .legal p{ color: var(--text-muted); font-size: 12px; line-height: 1.6; margin: 0 0 8px; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H10T9QTSXJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H10T9QTSXJ', { anonymize_ip: true });
  </script>

  <meta property="og:title" content="Station Walk Score" />
  <meta property="og:description" content="交通利便性を定量比較する指標" />
  <meta property="og:image" content="https://station-walk-score.vercel.app/og.png" />
  <meta property="og:url" content="https://station-walk-score.vercel.app/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://station-walk-score.vercel.app/og.png" />
</head>

<body>
  <div class="card">
    <h1>Station Walk Score</h1>

    <div class="row">
      <input id="q" type="text" placeholder="駅名を入力（例：東京）" autocomplete="off" />
      <button id="btn" type="button">表示</button>
    </div>
    <div class="hint">候補は最大3件まで表示します。候補をクリックして確定できます。</div>

    <div id="err" class="error"></div>
    <div id="suggest" class="suggest"></div>
    <div id="result" class="result" style="display:none;"></div>

    <div id="historyBox" class="history">
      <div class="history-head">
        <div class="history-title">直近の検索</div>
        <div class="history-actions">
          <button id="clearHistoryBtn" type="button">履歴を消す</button>
        </div>
      </div>
      <div id="historyList" class="history-list"></div>
    </div>

    <div class="legal">
      <div class="legal-note">※Station Walk Score(SWS)は交通利便性をスコア化したものです。</div>

      <h2>運営者について</h2>
      <p>本サイトは個人が運営しています。</p>

      <h2>お問い合わせ</h2>
      <p class="legal-note">改善要望・不具合報告はこちらから送ってください（登録不要）。</p>

      <p>
        <a
          id="openForm"
          href="https://docs.google.com/forms/d/e/1FAIpQLScyX0QE1pdvxRCAB7Yvk6L15xnkQnh-YfYcFY9fmprtELLMyw/viewform"
          target="_blank"
          rel="noopener noreferrer"
          style="display:inline-block;padding:10px 12px;border:1px solid var(--border2);border-radius:10px;text-decoration:none"
        >こちら</a>
      </p>
    </div>
  </div>

  <script>
    /********************
     * Config
     ********************/
    const API_BASE = "https://stationwalkscore.onrender.com";
    const API_KEY  = "SWS_2025_9Qm7Vx1kP3rT8nL2aH6zY4cD0sW5uJ9e";
    const API_ROOT = API_BASE.replace(/\/$/, "");

    const HISTORY_KEY   = "sws_history_v1";
    const HISTORY_LIMIT = 5;

    /********************
     * DOM
     ********************/
    const $q       = document.getElementById("q");
    const $btn     = document.getElementById("btn");
    const $err     = document.getElementById("err");
    const $suggest = document.getElementById("suggest");
    const $result  = document.getElementById("result");

    const $historyBox = document.getElementById("historyBox");
    const $historyList = document.getElementById("historyList");
    const $clearHistoryBtn = document.getElementById("clearHistoryBtn");

    /********************
     * Analytics
     ********************/
    function track(eventName, params = {}) {
      if (window.gtag) gtag("event", eventName, params);
    }

    function trackStationSearch({ stationName, query, method, score, rank }) {
      if (!window.gtag) return;
      const scoreInt = (score != null) ? String(Number(score).toFixed(0)) : "";
      gtag("event", "station_search", {
        station_name: stationName || "",
        query: query || "",
        method: method || "",
        score: scoreInt,
        rank: rank != null ? String(rank) : ""
      });
    }

    document.getElementById("openForm")?.addEventListener("click", () => {
      track("open_feedback_form", { method: "button" });
    });

    /********************
     * Utils
     ********************/
    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function showErr(msg) { $err.style.display = "block"; $err.textContent = msg; }
    function hideErr() { $err.style.display = "none"; $err.textContent = ""; }

    function makeId() {
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function fmtTime(ts) {
      try {
        const d = new Date(ts);
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${mm}/${dd} ${hh}:${mi}`;
      } catch { return ""; }
    }

    /********************
     * History (localStorage)
     ********************/
    function saveHistory(arr) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        const list = Array.isArray(arr) ? arr : [];

        // backward compat: ensure id
        let changed = false;
        const patched = list.map(x => {
          if (x && !x.id) { changed = true; return { ...x, id: makeId() }; }
          return x;
        });
        if (changed) saveHistory(patched);

        return patched;
      } catch {
        return [];
      }
    }

    function upsertHistory({ stationName, score, ts = Date.now() }) {
      const list = loadHistory();
      const filtered = list.filter(x => x?.stationName !== stationName);
      const next = [{ id: makeId(), stationName, score, ts }, ...filtered].slice(0, HISTORY_LIMIT);
      saveHistory(next);
      return next;
    }

    function deleteHistoryById(id) {
      const next = loadHistory().filter(x => x?.id !== id);
      saveHistory(next);
      return next;
    }

    /********************
     * API
     ********************/
    async function getMatches(query) {
      const q = (query ?? "").trim();
      if (!q) return [];
      const url = `${API_ROOT}/lookup?q=${encodeURIComponent(q)}&key=${encodeURIComponent(API_KEY)}`;
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      const data = await res.json();
      return data.results || [];
    }

    /********************
     * Render
     ********************/
    function clearSuggest() { $suggest.innerHTML = ""; }

    function renderResult(stationName, score) {
      $result.style.display = "grid";
      $result.innerHTML = `
        <div class="name">${escapeHtml(stationName)}</div>
        <div class="score">${Number(score).toFixed(0)}</div>
      `;
    }

    function renderHistory() {
      const items = loadHistory();
      if (!items.length) {
        $historyBox.style.display = "none";
        $historyList.innerHTML = "";
        return;
      }

      $historyBox.style.display = "block";
      $historyList.innerHTML = "";

      for (const h of items) {
        const row = document.createElement("div");
        row.className = "history-item";
        row.innerHTML = `
          <button class="history-del" type="button" aria-label="delete">×</button>
          <div class="history-top">
            <div class="history-name">${escapeHtml(h.stationName || "")}</div>
            <div class="history-right">
              <div class="history-score">${Number(h.score ?? 0).toFixed(0)}</div>
              <div class="history-meta">${fmtTime(h.ts)}</div>
            </div>
          </div>
        `;

        row.addEventListener("click", () => {
          $q.value = h.stationName || "";
          submit("history_click");
          track("history_click", { station_name: h.stationName || "" });
        });

        row.querySelector(".history-del").addEventListener("click", (e) => {
          e.stopPropagation();
          deleteHistoryById(h.id);
          renderHistory();
          track("history_delete_one", { station_name: h.stationName || "" });
        });

        $historyList.appendChild(row);
      }
    }

    function renderSuggest(items, queryForLog = "") {
      clearSuggest();
      if (!items.length) return;

      items.slice(0, 3).forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.textContent = item.name;

        div.addEventListener("click", () => {
          $q.value = item.name;
          clearSuggest();
          renderResult(item.name, item.score);

          trackStationSearch({
            stationName: item.name,
            query: (queryForLog ?? "").trim(),
            method: "suggest_click",
            score: item.score,
            rank: idx + 1
          });

          upsertHistory({ stationName: item.name, score: item.score });
          renderHistory();
        });

        $suggest.appendChild(div);
      });
    }

    /********************
     * Actions
     ********************/
    async function submit(method = "button") {
      hideErr();
      const query = ($q.value ?? "").trim();

      try {
        const matches = await getMatches(query);
        if (!matches.length) {
          clearSuggest();
          $result.style.display = "grid";
          $result.innerHTML = `
            <div class="name">見つかりません</div>
            <div class="score">-</div>
          `;
          return;
        }

        const top = matches[0];
        renderResult(top.name, top.score);
        renderSuggest(matches, query);

        trackStationSearch({
          stationName: top.name,
          query,
          method,
          score: top.score
        });

        upsertHistory({ stationName: top.name, score: top.score });
        renderHistory();

      } catch (e) {
        showErr("APIに接続できませんでした。APIが起動しているか、URL/CORS設定を確認してください。");
        console.error(e);
      }
    }

    /********************
     * Events
     ********************/
    let debounceTimer = null;

    $q.addEventListener("input", () => {
      hideErr();
      clearTimeout(debounceTimer);

      const v = ($q.value ?? "").trim();
      if (!v) { clearSuggest(); $result.style.display = "none"; return; }

      debounceTimer = setTimeout(async () => {
        try {
          const matches = await getMatches(v);
          renderSuggest(matches, v);
        } catch (e) {
          console.error(e);
        }
      }, 200);
    });

    $q.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); submit("enter"); }
    });

    $btn.addEventListener("click", () => submit("button"));

    $clearHistoryBtn.addEventListener("click", () => {
      if (!confirm("検索履歴を削除しますか？")) return;
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
      track("history_clear");
    });

    // initial
    renderHistory();
  </script>
</body>
</html>
