<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Station Walk Score</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; margin: 24px; }
    .card { max-width: 720px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 16px; padding: 18px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    input { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; }
    button { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background: #fff; cursor: pointer; }
    button:hover { background: #f9fafb; }
    .hint { color: #6b7280; font-size: 13px; margin-top: 8px; }
    .suggest { margin-top: 10px; }
    .suggest-item { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-top: 8px; cursor: pointer; user-select: none; }
    .suggest-item:hover { background: #f9fafb; }
    .result { margin-top: 14px; padding: 12px; border-radius: 12px; background: #f9fafb; border: 1px solid #e5e7eb; }
    .result .name { font-size: 18px; font-weight: 700; }
    .result .score { margin-top: 6px; font-size: 28px; font-weight: 800; }
    .muted { color: #6b7280; font-size: 13px; }
    .legal { margin-top: 16px; padding-top: 12px; border-top: 1px solid #e5e7eb; }
    .legal-note { color: #6b7280; font-size: 12px; line-height: 1.6; margin: 0 0 10px; }
    .legal h2 { font-size: 14px; margin: 12px 0 6px; }
    .legal p { color: #6b7280; font-size: 12px; line-height: 1.6; margin: 0 0 8px; }
    .error { color: #b91c1c; font-size: 12px; margin-top: 10px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H10T9QTSXJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H10T9QTSXJ', { anonymize_ip: true });
  </script>

  <meta property="og:title" content="Station Walk Score" />
  <meta property="og:description" content="交通利便性を定量比較する指標" />
  <meta property="og:image" content="https://station-walk-score.vercel.app/og.png" />
  <meta property="og:url" content="https://station-walk-score.vercel.app/" />
  <meta property="og:type" content="website" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://station-walk-score.vercel.app/og.png" />
</head>

<body>
  <div class="card">
    <h1>Station Walk Score</h1>

    <div class="row">
      <input id="q" type="text" placeholder="駅名を入力（例：東京）" autocomplete="off" />
      <button id="btn">表示</button>
    </div>
    <div class="hint">候補は最大3件まで表示します。候補をクリックして確定できます。</div>

    <div id="err" class="error" style="display:none;"></div>
    <div id="suggest" class="suggest"></div>
    <div id="result" class="result" style="display:none;"></div>

    <div class="legal">
      <div class="legal-note">※Station Walk Score(SWS)は交通利便性をスコア化したものです。</div>

      <h2>運営者について</h2>
      <p>本サイトは個人が運営しています。</p>

      <h2>お問い合わせ</h2>
      <p class="legal-note">改善要望・不具合報告はこちらから送ってください（登録不要）。</p>

      <p>
        <a
          id="openForm"
          href="https://docs.google.com/forms/d/e/1FAIpQLScyX0QE1pdvxRCAB7Yvk6L15xnkQnh-YfYcFY9fmprtELLMyw/viewform"
          target="_blank"
          rel="noopener noreferrer"
          style="display:inline-block;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;text-decoration:none"
        >
          こちら
        </a>
      </p>
    </div>
  </div>

  <script>
    // ========= 設定 =========
    const API_BASE = "https://stationwalkscore.onrender.com";
    const API_KEY  = "SWS_2025_9Qm7Vx1kP3rT8nL2aH6zY4cD0sW5uJ9e";
    const API_ROOT = API_BASE.replace(/\/$/, "");

    // ========= GA4 helper =========
    function track(eventName, params = {}) {
      if (window.gtag) gtag('event', eventName, params);
    }

    // ★駅名集計の本体：駅名が「確定した瞬間」だけ送る
    function trackStationSearch({ stationName, query, method, score, rank }) {
      if (!window.gtag) return;
      const scoreInt = (score != null) ? String(Number(score).toFixed(0)) : "";
      gtag("event", "station_search", {
        station_name: stationName || "",
        query: query || "",
        method: method || "",
        score: scoreInt,
        // 候補クリック時だけ入る（任意）
        rank: rank != null ? String(rank) : ""
      });
    }

    // ========= DOM =========
    const qEl = document.getElementById("q");
    const suggestEl = document.getElementById("suggest");
    const resultEl = document.getElementById("result");
    const btnEl = document.getElementById("btn");
    const errEl = document.getElementById("err");

    // アンケートボタンの計測（残す）
    document.getElementById("openForm")?.addEventListener("click", () => {
      track("open_feedback_form", { method: "button" });
    });

    function showErr(msg) { errEl.style.display = "block"; errEl.textContent = msg; }
    function hideErr() { errEl.style.display = "none"; errEl.textContent = ""; }

    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, function(m) {
        return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[m];
      });
    }

    // ★ここではGA送らない（表示イベントはノイズになるので）
    function renderResult(name, score) {
      resultEl.style.display = "block";
      const scoreInt = Number(score).toFixed(0);
      resultEl.innerHTML = `
        <div class="name">${escapeHtml(name)}</div>
        <div class="muted">Station Walk Score</div>
        <div class="score">${scoreInt}</div>
      `;
    }

    function clearSuggest() { suggestEl.innerHTML = ""; }

    async function getMatches(query) {
      const q = (query ?? "").trim();
      if (!q) return [];
      const url = `${API_ROOT}/lookup?q=${encodeURIComponent(q)}&key=${encodeURIComponent(API_KEY)}`;
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      const data = await res.json();
      return data.results || [];
    }

    function renderSuggest(items, queryForLog = "") {
      clearSuggest();
      if (!items.length) return;

      const shown = items.slice(0, 3);

      shown.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.textContent = item.name;
        div.addEventListener("click", () => {
          qEl.value = item.name;
          clearSuggest();
          renderResult(item.name, item.score);

          // ★候補クリックで駅名が確定したので送る
          trackStationSearch({
            stationName: item.name,
            query: (queryForLog ?? "").trim(),
            method: "suggest_click",
            score: item.score,
            rank: idx + 1
          });
        });
        suggestEl.appendChild(div);
      });
    }

    // ★検索確定（Enter/ボタン）で station_search を送る
    async function submit(method = "button") {
      hideErr();
      const query = (qEl.value ?? "").trim();

      try {
        const matches = await getMatches(query);
        if (matches.length) {
          const top = matches[0];
          renderResult(top.name, top.score);
          renderSuggest(matches, query);

          trackStationSearch({
            stationName: top.name,
            query,
            method,
            score: top.score
          });
        } else {
          clearSuggest();
          resultEl.style.display = "block";
          resultEl.innerHTML = `<div class="name">見つかりません</div><div class="muted">別の駅名で試してください</div>`;
          // 任意：見つからない検索も見たい場合だけ
          // track("station_not_found", { query, method });
        }
      } catch (e) {
        showErr("APIに接続できませんでした。APIが起動しているか、URL/CORS設定を確認してください。");
        console.error(e);
        // 任意：障害監視したい場合だけ
        // track("api_error", { message: String(e?.message || e) });
      }
    }

    let debounceTimer = null;
    qEl.addEventListener("input", () => {
      hideErr();
      clearTimeout(debounceTimer);
      const v = qEl.value;
      if (!v.trim()) { clearSuggest(); resultEl.style.display = "none"; return; }

      debounceTimer = setTimeout(async () => {
        try {
          const matches = await getMatches(v);
          renderSuggest(matches, (v ?? "").trim());
        } catch (e) {
          console.error(e);
        }
      }, 200);
    });

    qEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); submit("enter"); }
    });

    btnEl.addEventListener("click", () => submit("button"));
  </script>
</body>
</html>
